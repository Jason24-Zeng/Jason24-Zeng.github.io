---
title: 搜索框架
date: 2022-02-19 17:54:56
tags: 
- Search Structure
categories:
- Search
password: 0831
cover: /img/SearchEnginee/searchplatform.png
top_img: /img/git-多人开发-与-分支管理/git-flow.webp
---

## Unit Search US 代码

Unit Search 侧的代码主要起到发送请求给 ElasticSearch 进行索引召回，并对索引召回进行一定排序，最终将排序后的文本结构体传给 Search Server (SS) 的工作。最主要需要看的是两部分目录代码：

1. frame 目录，是整体的主程序目录，用于指定初始化配置以及整体召回排序逻辑框架的部分。

2. strategy 目录，算法侧开发召回语法与排序逻辑的主要目录。

### Frame 框架代码结构

#### 启动

这部分在 `frame/us.cpp` 中，在 main 函数中执行。

#### 接收请求

这部分在 `frame/us_server.cpp` 中，找到其声明的 `Search()` 函数，不同的垂搜可能对应不同的逻辑主体。

#### 核心逻辑流程代码

在 `frame/command_exe.cpp`，主要核心是 3 个阶段，主体在 `CommandExe::doCommand()` 函数中执行具体步骤

配置文件在 `conf/cmd_xxx.conf.template` 中配置。每个阶段都调用对应的类的 `process` 函数，主要步骤有

1. query 分析

2. 发送召回请求，请求 ES

3. 接收召回结果

4. 召回结果合并，VideoPackResult

5. 排序，VideoResultRank，策略排序核心

6. 多路策略合并逻辑

7. 结果队列打包

## Reference

[video-us开发部署&代码阅读](https://huxinchen.notion.site/video-us-b024d0aa523040dba340cd0ebdc111e5)

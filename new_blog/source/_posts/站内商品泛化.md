---
title: 站内商品泛化
date: 2023-03-19 19:35:43
tags: 
- 视频商品相关性
categories:
- Business MindMap
- Search
password: 0418
cover: /img/站内商品泛化/entire_workflow.png
top_img: /img/站内商品泛化/entire_workflow.png
---

# 背景

目前产品要求的商品挂车逻辑是一个视频只能挂一个item， 一旦爬取视频挂车并发布，当前视频不能在被其他的商品挂车，此种挂车的方式会导致视频资源相互挤占和资源供给紧张。

为了解决此问题，引入多场景的概念，满足一个视频在多场景（Scenario）进行挂车的需求，supply 圈定每个场景的item pool，每个场景（Scenario）限定在当前的场景范围内召回item，视频相互挤占问题从全局挤占转化为按场景（Scenario）独立存储。

另外，随着业务发展，电商视频的投放逐步由视频投放为主转变为item投放带出视频的模式，所以业务方期望一个视频可以挂多个同款商品，来增加覆盖。

Supply侧产品PRD：https://confluence.shopee.io/pages/viewpage.action?pageId=1649978478

Search侧产品PRD：https://confluence.shopee.io/pages/viewpage.action?pageId=1661461920

本TD主要讨论根据场景做商品泛化的匹配以及整条链路的设计。

TD主要有下面几章：

- 二、相关能力梳理

- 三、泛化流程

- 四、整体流程

- 五、爬虫侧依赖

- 六、整体排期

# 相关能力梳理

## 商品检索商品服务

Video Search 组内之前建设过一个shopee 商品-商品检索服务，通过商品 id 对商品库内商品做检索。该项目应用于之前多个供给项目中，检索服务项目主页：[shopee高热商品检索中热商品](https://confluence.shopee.io/pages/viewpage.action?pageId=1361221089)

计划将该服务作为一路商品召回。

在调研 case 上，服务检索分数在指定阈值下，结合人工标注，商品-商品相关性表现如下：

- 设定阈值 > 0.5，有结果率为 89 %，pair 对准确率为 90.5%，有结果数据中平均结果数为 34.7 个

- 设定阈值 > 0.6，有结果率为 83 %，pair 对准确率为 95.2%，有结果数据中平均结果数为 25.6 个

（上面是本次随机看了20多个case得到的结论，Q4也做过类似调研，那时候阈值>0.75时，有结果率为60%，pair准确率95%左右，有结果数据中平均结果数14.7个。）

根据有结果率和准确率情况，将该路纳入召回是可行的。

该检索库的整体范围是订单top200万商品+PV top200万商品，去重后大概250~300万商品。

为了对召回的商品做进一步补充，另外加入：a. 主站商品KNN检索结果，b. 主站以图搜商品，c. 主站文本搜索商品 三条召回路。

## 主站商品 KNN 检索能力

主站当前具有对商品进行了 KNN 检索的能力，其可以天级生成「 item_id - 召回 item 列表」 关系，并以 hive 表的形式给出。目前我们已经对召回商品进行 knn 分数的简单过滤，并将过滤后的关系以 item_id 为 key 写到 redis。

在调研 case 上，我们从 redis 中获取检索结果，结合人工标注，商品-商品相关性表现如下：

- 设定阈值 > 0.90，有结果率为 95%，pair 对准确率为 90.5 %，平均结果数为 62.5 个

- 设定阈值 > 0.95，有结果率为 91.5% ，pair 对准确率约 100%，平均结果数为 38.1 个

根据有结果率和准确率情况，将该路纳入召回是可行的。

商品库为 ID 地区历史总销量>0的商品，库大小为5000万左右。

## 主站以图搜商品服务

Shopee手机APP上有以图搜商品的功能，根据之前试用，能有比较不错的效果，期望能够利用此能力到商品泛化项目中，作为一路商品召回。

因触发商品为 shopee 商品，我们可以获得商品详情页的展示图片列表。使用主站以图搜商品服务，我们对同一商品的 图片列表进行检索并聚合，并根据图片相关性分进行召回商品排序。

以图搜商品返回得分不同阈值下，结合人工标注，商品-商品相关性表现如下：

- 设定阈值 > 0.98，有结果率为 86 %，pair 对准确率为 90.5%，平均结果数为 65.0 个

- 设定阈值 > 0.99，有结果率为 75%，pair 对准确率为约 100%，平均结果数为 54.4 个

根据有结果率和准确率情况，将该路纳入召回是可行的。

商品库为ID地区历史总销量>0的商品，库大小为5000万左右。

## 主站文本搜索服务

我们期望调用该文本搜索服务，即 Shopee 主站 query 搜索能力，作为一路商品召回，运用到商品泛化项目。

为调研该服务的可用性，我们将触发商品的 caption 作为 query，去请求该服务，将服务召回商品的 caption 与 触发商品的 caption 计算匹配度（匹配度 = term 交集去重 size / term 并集去重 size）。结合人工标注，商品-商品相关性表现如下：

- 设定匹配度 > 0.8，有结果率为 47%，pair 对准确率为 95%，平均结果数为 11.0 个

根据有结果率和准确率情况，将该路纳入召回是可行的。

# 泛化流程

## 前置要求

### 概念

首先明确两个容易混淆的概念：

- scenario：要求做泛化的业务化场景，与业务直接挂钩，如 Highlight Video DD, Highlight Video Search, Highlight Video YMAL 等场景

- db：商品所属库，项目内部实际维护的数据库，当前与 scenario 之间为一一对应关系。未来可能一个 scenario 要求多个检索库，多个 scenario 也可能要求使用同一检索库。另外，不同 db 间有交叉。

其次定义一些商品的属性：

1. 白牌：商品没有品牌信息

### 依赖数据

#### 召回商品 db redis

该 redis 记录商品所属检索库 db 列表，存储的 key 为 item_id，过期时间 7 天

#### 商品信息 rpc

商品信息获取服务 rpc，通过给出 shopee item_id 列表，返回 item 相关的基础商品属性，包括 店铺，类目，商品库存，商品状态（比如是否下架等），商品销量等

#### 检索结果缓存 redis

目前一些依赖服务的 QPS 是整个项目的瓶颈，当前触发商品有一定概率重复，而重复请求这些服务会降低整个服务的效率，因此我们设置如下缓存 redis，用以记录每路检索召回的结果信息，json 结构如下：

```json
{
"recall_spitem_search_db_default": [{"item_id": 0, "score":1.0}, ...],
"recall_main_cluster": [{"item_id": 0, "score":1.0}, ...],
"recall_main_img": [{"item_id": 0, "score":1.0}, ...],
"recall_main_text": [{"item_id": 0, "score": 1.0}, ...]
}
```

存储的 key 为 item_id，过期时间为 3 天

## 流程介绍

该章节主要介绍对单条信号的泛化流程，详细流程图为：

![算法流程v1](https://jason24-zeng.github.io/img/站内商品泛化/search_workflow_v1.png)

在确保商品需要泛化条件下，流程会通过召回-过滤-分派（dispatch）三个阶段，对商品进行泛化。

### 检索层

使用第二章提到的相关能力，对商品进行召回，每路召回维护一个召回列表，并对多路召回列表进行缓存。如果在召回前发现 item-id 命中缓存，直接使用缓存信息作为召回结果。

注意点：

1. 每路召回的检索库均为天级更新，新加 scenario 与 db 并不会更新检索库内容。

讨论：

为了保证每个 db 的数据尽可能在 250w 高热库中进行召回，我们考虑对商品检索商品进行多次分 db 召回，整体流程如图：

![算法流程v2](https://jason24-zeng.github.io/img/站内商品泛化/search_workflow_v2.png)

优点：

1. 减少高热库某些 db 内商品未召回的损失

缺点：

1. 请求服务的 QPS 增加 n 倍，n 取决于 db 数量

2. 开发成本上升，需要在 US 侧修改召回逻辑 并且 给 ES 侧增加字段判定商品 db

3. 每个 item 的缓存大小增加

### 规则层

小黄车服务能够广义得给出一个视频与商品的相关性，但是，当前没有一个服务能统一并全面地去表征商品-商品的相关性，因此，我们无法通过统一对召回的商品进行排序与阈值过滤。

退而求其次地，我们在获取召回商品属性后，对每路召回结果进行通用与定制化的过滤，保证泛化结果的准确性。

最终将过滤后的集合列表聚合成一个集合。

（计算商品-商品 pair对相关性能力问题，问过主站团队和MMU团队，均没有现成能力。）

#### 通用过滤

某个召回商品需要被过滤的条件（满足其一即可）：

- 商品未取到属性信息

- 商品状态不为 1

- 商品存量为 0

- 触发商品为白牌，匹配到了非白牌商品，或匹配到了白牌商品价格差异过大

- 触发商品不为白牌且触发商品与召回商品不为同一品牌

- 触发商品与召回商品同店铺

- 前面未过滤召回商品与当前召回商品同店铺（即召回结果中商品要求非同店铺）

- 召回商品无类目信息

#### 定制化过滤

##### Search 检索服务过滤

某个通过 Search 召回商品需要被过滤的条件（满足其一即可）：

- 触发商品非白牌

- 触发商品一级类目具有指定 l1 非白牌阈值且召回商品分数低于指定 l1 非白牌阈值

- 触发商品二级类目具有指定 l2 非白牌阈值且召回商品分数低于指定 l2 非白牌阈值

- 召回商品分数低于指定 general 非白牌阈值

- 触发商品为白牌

- 触发商品一级类目具有指定 l1 白牌阈值且召回商品分数低于指定 l1 白牌阈值

- 触发商品二级类目具有指定 l2 白牌阈值且召回商品分数低于指定 l2 白牌阈值

- 召回商品分数低于指定 general 白牌阈值

##### KNN 服务过滤

某个通过主站 KNN 检索服务 被召回商品需要被过滤的条件（满足其一即可）：

- 触发商品非白牌

- 触发商品一级类目具有指定 l1 非白牌阈值且召回商品分数低于指定 l1 非白牌阈值

- 触发商品二级类目具有指定 l2 非白牌阈值且召回商品分数低于指定 l2 非白牌阈值

- 召回商品分数低于指定 general 非白牌阈值

- 触发商品为白牌

- 触发商品一级类目具有指定 l1 白牌阈值且召回商品分数低于指定 l1 白牌阈值

- 触发商品二级类目具有指定 l2 白牌阈值且召回商品分数低于指定 l2 白牌阈值

- 召回商品分数低于指定 general 白牌阈值

##### 图搜服务过滤

某个通过 以图搜商品服务 被召回商品需要被过滤的条件（满足其一即可）：

- 触发商品非白牌

- 触发商品一级类目具有指定 l1 非白牌阈值且召回商品分数低于指定 l1 非白牌阈值

- 触发商品二级类目具有指定 l2 非白牌阈值且召回商品分数低于指定 l2 非白牌阈值

- 召回商品分数低于指定 general 非白牌阈值

- 触发商品为白牌

- 触发商品一级类目具有指定 l1 白牌阈值且召回商品分数低于指定 l1 白牌阈值

- 触发商品二级类目具有指定 l2 白牌阈值且召回商品分数低于指定 l2 白牌阈值

- 召回商品分数低于指定 general 白牌阈值

##### 文本搜索服务过滤

某个通过 query 搜商品服务 被召回商品需要被过滤的条件（满足其一即可）：

- 触发商品非白牌

- 触发商品一级类目具有指定 l1 非白牌阈值且召回商品分数低于指定 l1 非白牌阈值

- 触发商品二级类目具有指定 l2 非白牌阈值且召回商品分数低于指定 l2 非白牌阈值

- 召回商品分数低于指定 general 非白牌阈值

- 触发商品为白牌

- 触发商品一级类目具有指定 l1 白牌阈值且召回商品分数低于指定 l1 白牌阈值

- 触发商品二级类目具有指定 l2 白牌阈值且召回商品分数低于指定 l2 白牌阈值

- 召回商品分数低于指定 general 白牌阈值

注意：此处的分数为 触发商品 caption 与 召回商品 caption 的 bm25 分数

### 分派（dispatch）层

首先，我们将商品集合列表合并为一个商品集合。

其次，通过 redis 我们拉取到「合并商品集」中各商品的 db 信息，结合 scenario-db 映射关系，我们将商品分发到所属的 scenario，再通过业务过滤层，最终输出各 scenario 商品泛化结果到指定 kafka。

注意：redis 存储的是 item 对应 db 信息，并使用 scenario-db 关系获取商品对应 scenario 信息，而不是直接存储 item 对应 scenario 信息。这里的考虑是，scenario-db 并非 一一 对应关系，当新增 scenario 时，可能该 scenario 会使用旧 db。这时候，如果存储的是 item-scenario 信息，需要重刷 redis，而如果存储的是 item-db 时，db 不需要重刷，只用新增一条 scenario-db 关系即可。

# 整体流程

商品泛化整体项目流程如下图

![整体流程](https://jason24-zeng.github.io/img/站内商品泛化/entire_workflow.png)

在原来的流程中，爬虫会将爬取的视频写入kafka，并给定供给项目的 scenario。供给各项目会根据 scenario 消费 kafka 信息，执行相应的匹配流程，并将匹配结果传给输出 kafka，其他信息透传。我们将该流程定义为主流程。

在主流程的基础上，商品泛化增加一条旁路流程。改动有：

1. 爬虫输入侧 kafka 增加列表字段 scenario_list 作为泛化 scenario。如果不需要泛化，该字段填空或不填

2. 各供给项目在完成匹配之后，如果有匹配商品且 scenario_list 不为空，除了向爬虫输出 kafka 外，也向泛化旁路 输入kafka 信息。

3. 泛化模块读取 「泛化输入kafka」信息，进行商品泛化流程

4. 对 scenario_list 中的每个 scenario 泛化结果，输出信息到 kafka 中，注意输出信息中 scenario 字段需要覆盖为进行泛化的scenario
